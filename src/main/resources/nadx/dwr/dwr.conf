rdb {
  url = "jdbc:mysql://node17:3306/sight"
  user = "root"
  password = "root_root"
  kafka.offset.table = "offset"
  transaction.manager.table="sight.transaction_commited_table"
}
hive {
  jdbc.url = "jdbc:hive2://master:10000/default"
}
message.client.url="http://node14:5555/"
kylin.client.url="http://node14:7070/kylin/api/"
kafka.producer {
  is.async=false
  set {
    bootstrap.servers="node187:6667"
    client.id="niubility_producer"
    acks=-1
    key.serializer="org.apache.kafka.common.serialization.StringSerializer"
    value.serializer="org.apache.kafka.common.serialization.StringSerializer"
  }
}
kafka.consumer {
  set {
    bootstrap.servers = "node187:6667"
    key.deserializer = "org.apache.kafka.common.serialization.StringDeserializer"
    value.deserializer = "org.apache.kafka.common.serialization.StringDeserializer"
//    auto.offset.reset = "earliest"
        auto.offset.reset = "latest"
    enable.auto.commit = "false"
    request.timeout.ms = 2000
    session.timeout.ms = 1500
    heartbeat.interval.ms = 1000
  }
}
hbase {
  set {
    hbase.zookeeper.quorum = "master,node187"
    hbase.zookeeper.property.clientPort = "2181"
    spark.serializer = org.apache.spark.serializer.KryoSerializer
  }
}
spark.conf {
  app.name = "nadx_overall"
  streaming.batch.buration = 100
  set {
    mapreduce.job.queuename = queueA
    mapreduce.job.priority = HIGH
    hive.default.fileformat=Orc
    hive.exec.dynamic.partition.mode = nonstrict
    //    spark.streaming.kafka.maxRatePerPartition = 2000
    spark.streaming.kafka.maxRatePerPartition = 3000
    #spark.streaming.receiver.maxRate=1000
    spark.serializer = org.apache.spark.serializer.KryoSerializer
    spark.default.parallelism = 8
    hive.merge.mapfiles = true
    hive.merge.mapredfiles = true
    hive.merge.smallfiles.avgsize=1024000000
    spark.sql.shuffle.partitions = 8
    spark.kryoserializer.buffer.max=256
    spark.scheduler.mode=FAIR
    spark.history.fs.cleaner.enabled = true
    spark.history.fs.cleaner.interval = 1d
    spark.history.fs.cleaner.maxAge = 3d
    //    spark.streaming.concurrentJobs = 6
  }
}
modules {
//  site_app_id,
//  placement_id,
//  city,
//  carrier,
//  os_version,
//  device_brand,
//  device_model,
//  bundle
  dwr_traffic {
    class = "com.mobikok.ssp.data.streaming.module.PluggableModule"
    // timestamp 精确到了秒,非毫秒，所以不用除于1000
    business.time.extract.by = "from_unixtime(timestamp, 'yyyy-MM-dd HH:mm:ss')"
    master = true
    dwi.enable = true
    dwi.table = "nadx_overall_traffic_dwi"
    dwi.kafka.schema = "com.mobikok.ssp.data.streaming.schema.dwi.kafka.NadxTrafficDWISchema"
    dwr.enable = true
    dwr.groupby.fields = [
      { expr = "supply_bd_id",       as = "supply_bd_id"},
      { expr = "supply_am_id",       as = "supply_am_id"},
      { expr = "supply_id",          as = "supply_id"},
      { expr = "supply_protocol",    as = "supply_protocol"},
      { expr = "request_flag",       as = "request_flag"},

      { expr = "ad_format",          as = "ad_format"},
      { expr = "site_app_id",        as = "site_app_id"},
      { expr = "placement_id",       as = "placement_id"},
      { expr = "position",           as = "position"},
      { expr = "country",            as = "country"},

      { expr = "state",              as = "state"},
      { expr = "city",               as = "city"},
      { expr = "carrier",            as = "carrier"},
      { expr = "os",                 as = "os"},
      { expr = "os_version",         as = "os_version"},

      { expr = "device_type",        as = "device_type"},
      { expr = "device_brand",       as = "device_brand"},
      { expr = "device_model",       as = "device_model"},
      { expr = "age",                as = "age"},
      { expr = "gender",             as = "gender"},

      { expr = "cost_currency",      as = "cost_currency"},
      { expr = "demand_bd_id",       as = "demand_bd_id"},
      { expr = "demand_am_id",       as = "demand_am_id"},
      { expr = "demand_id",          as = "demand_id"},
      { expr = "demand_protocol",    as = "demand_protocol"},

      { expr = "revenue_currency",   as = "revenue_currency"},
      { expr = "demand_seat_id",     as = "demand_seat_id"},
      { expr = "demand_campaign_id", as = "demand_campaign_id"},
      { expr = "target_site_app_id", as = "target_site_app_id"},
      { expr = "bid_price_model",    as = "bid_price_model"},

      { expr = "traffic_type",       as = "traffic_type"},
      { expr = "currency",           as = "currency"},
      { expr = "bundle",               as = "bundle"},
      { expr = "size",               as = "size"},

      // 待删，用tip_type
      { expr = "null",               as = "tips"},
      { expr = "node",               as = "node"},
      { expr = "tip_type",           as = "tip_type"},
      { expr = "tip_desc",           as = "tip_desc"},
      { expr = "ssp_token",          as = "ssp_token"},
      { expr = "rtb_version",       as = "rtb_version" },
      { expr = "demand_using_time", as = "demand_using_time" },
      { expr = "adx_using_time",    as = "adx_using_time" },
      { expr = "site_domain",        as = "site_domain"},
      { expr = "publisher_id",        as = "publisher_id"},
      { expr = "rater_type",           as = "rater_type"},
      { expr = "rater_id",             as = "rater_id"},
      { expr = "null",           as = "raterType"},
      { expr = "null",             as = "raterId"},
      { expr = "adomain",             as = "adomain"},
      { expr = "crid",                as = "crid"},
      { expr = "media_type",                as = "media_type"}
    ]
    dwr.groupby.aggs = [
      { expr = "sum(supply_request_count)",                                                     as ="supply_request_count",              union = "sum(supply_request_count)"},
      { expr = "sum(supply_invalid_request_count)",                                             as ="supply_invalid_request_count",      union = "sum(supply_invalid_request_count)"},
      { expr = "sum(supply_bid_count)",                                                         as ="supply_bid_count",                  union = "sum(supply_bid_count)"},
      { expr = "sum(supply_bid_price_cost_currency/ IF(bid_price_model = 1, 1000.0, 1.0) )",    as ="supply_bid_price_cost_currency",    union = "sum(supply_bid_price_cost_currency)"},
      { expr = "sum(supply_bid_price/ IF(bid_price_model = 1, 1000.0, 1.0) )",                  as ="supply_bid_price",                  union = "sum(supply_bid_price)"},
      { expr = "0",                                                                             as ="supply_win_count",                  union = "sum(supply_win_count)",               overwrite = true},
      { expr = "0.0",                                                                           as ="supply_win_price_cost_currency",    union = "sum(supply_win_price_cost_currency)", overwrite = true},
      { expr = "0.0",                                                                           as ="supply_win_price",                  union = "sum(supply_win_price)",               overwrite = true},
      { expr = "sum(demand_request_count)",                                                     as ="demand_request_count",              union = "sum(demand_request_count)"},
      { expr = "sum(demand_bid_count)",                                                         as ="demand_bid_count",                  union = "sum(demand_bid_count)"},

      { expr = "sum(demand_bid_price_revenue_currency/ IF(bid_price_model = 1, 1000.0, 1.0) )", as ="demand_bid_price_revenue_currency", union = "sum(demand_bid_price_revenue_currency)"},
      { expr = "sum(demand_bid_price/ IF(bid_price_model = 1, 1000.0, 1.0))",                   as ="demand_bid_price",                  union = "sum(demand_bid_price)"},
      { expr = "0",                                                                             as ="demand_win_count",                  union = "sum(demand_win_count)"},
      { expr = "0.0",                                                                           as ="demand_win_price_revenue_currency", union = "sum(demand_win_price_revenue_currency)"},
      { expr = "0.0",                                                                           as ="demand_win_price",                  union = "sum(demand_win_price)"},

      { expr = "0",                                                                             as ="demand_timeout_count",              union = "sum(demand_timeout_count)"},
      { expr = "0",                                                                             as ="impression_count",                  union = "sum(impression_count)",            overwrite = true},

      { expr = "0.0",                                                                           as ="impression_cost_currency",          union = "sum(impression_cost_currency)",    overwrite = true},
      { expr = "0.0",                                                                           as ="impression_cost",                   union = "sum(impression_cost)",             overwrite = true},

      {expr = "0.0",                                                                            as ="impression_revenue_currency",       union = "sum(impression_revenue_currency)", overwrite = true},

      { expr = "0.0",                                                                           as ="impression_revenue",                union = "sum(impression_revenue)",          overwrite = true},
      { expr = "0",                                                                             as ="click_count",                       union = "sum(click_count)",                 overwrite = true},

      { expr = "0.0",                                                                           as ="click_cost_currency",               union = "sum(click_cost_currency)",         overwrite = true},
      { expr = "0.0",                                                                           as ="click_cost",                        union = "sum(click_cost)",                  overwrite = true},
      { expr = "0.0",                                                                           as ="click_revenue_currency",            union = "sum(click_revenue_currency)",      overwrite = true},

      { expr = "0.0",                                                                           as ="click_revenue",                     union = "sum(click_revenue)",               overwrite = true},
      { expr = "0",                                                                             as ="conversion_count",                  union = "sum(conversion_count)",            overwrite = true},
      { expr = "0.0",                                                                           as ="conversion_price",                  union = "sum(conversion_price)",            overwrite = true},
      { expr = "0",                                                                             as ="event_count",                       union = "sum(event_count)",                 overwrite = true},
      { expr = "0.0",                                                                           as ="bidfloor",                          union = "avg(bidfloor)",                    overwrite = true}

    ]
    dwr.include.repeated = true 
    dwr.table = "nadx_overall_dwr"
    kafka.consumer {
      partitoins = [
        {topic = "traffic_topic"}
      ]
    }
  }

  dwr_performance {
    class = "com.mobikok.ssp.data.streaming.module.PluggableModule"
    // timestamp 精确到了秒,非毫秒，所以不用除于1000
//    business.time.extract.by = "from_unixtime(timestamp, 'yyyy-MM-dd HH:mm:ss')"
    b_time.input = "from_unixtime(timestamp, 'yyyy-MM-dd HH:mm:ss')"
//    l_time.output = "0001-01-01 00:00:00"
    overwrite = true
    dwi.enable = true
    dwi.table = "nadx_overall_performance_matched_dwi"
    dwi.kafka.schema = "com.mobikok.ssp.data.streaming.schema.dwi.kafka.NadxTrafficDWISchema"
    dwi.handler = [{
      class = "com.mobikok.ssp.data.streaming.handler.dwi.SQLHandler"
      message.topics = ["nadx_performance_dwi", "nadx_traffic_dwi"]
      message.consumer = "nadx_p_matched_dwi_cer"
      sql = """
        drop view if exists nadx_p_matched_dwi_tmp;
        create temporary view nadx_p_matched_dwi_tmp as
        select
          pDwi.repeats,
          pDwi.rowkey,

          pDwi.type      AS type,
          pDwi.bidTime   AS bidTime,
          pDwi.supplyid  AS supplyid,
          pDwi.bidid     AS bidid,
          pDwi.impid     AS impid,
          pDwi.price     AS price,
          pDwi.cur       AS cur,
          pDwi.withPrice AS withPrice,
          pDwi.eventType AS eventType,

          CASE pDwi.type
            WHEN 'win' then 5
            WHEN 'impression' then 6
            WHEN 'click' then 7
            WHEN 'conversion' then 8
            WHEN 'event' THEN (CASE pDwi.eventType
              WHEN 1 THEN 6
              WHEN 2 THEN 7
              WHEN 3 THEN 7
              WHEN 4 THEN 7
              ELSE null END
            )
            ELSE null END
          AS dataType,

          tDwi.timestamp,
          tDwi.supply_bd_id,
          tDwi.supply_am_id,
          tDwi.supply_id,
          tDwi.supply_protocol,
          tDwi.request_flag,

          tDwi.ad_format,
          tDwi.site_app_id,
          tDwi.placement_id,
          tDwi.position,

          tDwi.country,
          tDwi.state,
          tDwi.city,

          tDwi.carrier,

          tDwi.os,
          tDwi.os_version,

          tDwi.device_type,
          tDwi.device_brand,
          tDwi.device_model,

          tDwi.age,
          tDwi.gender,

          tDwi.cost_currency,

          tDwi.demand_bd_id,
          tDwi.demand_am_id,
          tDwi.demand_id,

          tDwi.demand_seat_id,
          tDwi.demand_campaign_id,
          tDwi.demand_protocol,
          tDwi.target_site_app_id,
          tDwi.revenue_currency,

          tDwi.bid_price_model,
          tDwi.traffic_type,
          tDwi.currency,
          tDwi.supplyBidId,
          tDwi.bidRequestId,
        --   pDwi.bidid AS performanceBidRequestId,

          tDwi.bundle,
          tDwi.size,

          0  AS supply_request_count,
        --   待删
          0  AS supply_invalid_request_count,
          0  AS supply_bid_count,
          0. AS supply_bid_price_cost_currency,
          0. AS supply_bid_price,

          CASE pDwi.type
            WHEN 'win' THEN 1
            ELSE 0 END
          AS supply_win_count,

          CASE pDwi.type
            WHEN 'win' THEN (
             CASE
               WHEN (!pDwi.withPrice OR (pDwi.withPrice AND winDwi.price is null)) THEN tDwi.supply_bid_price_cost_currency
               ELSE (CASE
                 WHEN pDwi.cur is null OR pDwi.cur = tDwi.cost_currency THEN winDwi.price
                 ELSE winDwi.price*1.00000000 END
               ) END
            )
            ELSE 0. END
          AS supply_win_price_cost_currency,

          CASE pDwi.type
            WHEN 'win' THEN (
             CASE
               WHEN (!winDwi.withPrice OR (winDwi.withPrice AND winDwi.price is null)) THEN tDwi.supply_bid_price
               ELSE (CASE
                 WHEN pDwi.cur is null OR pDwi.cur = tDwi.cost_currency THEN (CASE
                   WHEN tDwi.cost_currency = tDwi.currency THEN winDwi.price
                   ELSE winDwi.price*1.000000 END
                 )
                 ELSE (CASE
                   WHEN pDwi.cur = tDwi.currency THEN winDwi.price
                   ELSE winDwi.price*1.000000 END
                 ) END
               ) END
            )
            ELSE 0. END
          AS supply_win_price,

          0  as demand_request_count,
          0  as demand_bid_count,
          0. as demand_bid_price_revenue_currency,
          0. as demand_bid_price,

          CASE pDwi.type
            WHEN 'win' THEN 1
            ELSE 0 END
          AS demand_win_count,

          CASE pDwi.type
            WHEN 'win' THEN tDwi.demand_win_price_revenue_currency
            ELSE 0. END
          AS demand_win_price_revenue_currency,

          CASE pDwi.type
            WHEN 'win' THEN tDwi.demand_win_price
            ELSE 0. END
          AS demand_win_price,

          -- 待删
          0  as demand_timeout_count,

          CASE pDwi.type
            WHEN 'impression' THEN 1
            WHEN 'event' THEN (CASE pDwi.eventType
              WHEN 1 THEN 1
              ELSE 0 END
            )
            ELSE 0 END
          AS impression_count,

          CASE pDwi.type
            WHEN 'impression' THEN (CASE
              WHEN !winDwi.withPrice OR winDwi.price is null THEN tDwi.supply_bid_price_cost_currency
              ELSE (CASE
                WHEN pDwi.cur is null OR pDwi.cur = tDwi.cost_currency THEN winDwi.price
                ELSE winDwi.price*1.0000000 END
              )END
            )
            ELSE 0. END
          AS impression_cost_currency,

          CASE pDwi.type
            WHEN 'impression' THEN (CASE
              WHEN !winDwi.withPrice OR winDwi.price is null THEN tDwi.supply_bid_price
              ELSE (CASE
                WHEN pDwi.cur is null OR pDwi.cur = tDwi.cost_currency THEN (CASE
                  WHEN tDwi.cost_currency = tDwi.currency THEN winDwi.price
                  ELSE winDwi.price*1.000000 END
                )
                ELSE (CASE
                  WHEN pDwi.cur = tDwi.currency THEN winDwi.price
                  ELSE winDwi.price*1.0000000 END
                ) END
              )END
            )
            ELSE 0. END
          AS impression_cost,

          CASE pDwi.type
            WHEN 'impression' THEN tDwi.demand_win_price_revenue_currency
            ELSE 0. END
          AS impression_revenue_currency,

          CASE pDwi.type
            WHEN 'impression' THEN tDwi.demand_win_price
            ELSE 0. END
          AS impression_revenue,

          CASE pDwi.type
            WHEN 'click' THEN 1
            WHEN 'event' THEN (CASE pDwi.eventType
              WHEN 2 THEN 1
              WHEN 3 THEN 1
              WHEN 4 THEN 1
              ELSE 0 END
            )
            ELSE 0 END
          AS click_count,

          0. as click_cost_currency,
          0. as click_cost,
          0. as click_revenue_currency,
          0. as click_revenue,

          CASE pDwi.type
            WHEN 'conversion' THEN 1
            ELSE 0 END
          AS conversion_count,

          0. as conversion_price,

          0 as saveCount,

          tDwi.bidfloor as bidfloor,
          tDwi.site_id as site_id,
          tDwi.site_cat as site_cat,
          tDwi.site_domain as site_domain,
          tDwi.publisher_id as publisher_id,
          tDwi.app_id as app_id,
          tDwi.tmax as tmax,
          tDwi.ip as ip,
          tDwi.crid as crid,
          tDwi.cid as cid,
        --   待删
          cast(null as string) as tips,
          pDwi.node as node,
          pDwi.tip_type,
          pDwi.tip_desc,
          tDwi.adm,

          CASE pDwi.type
            WHEN 'event' THEN 1
            ELSE 0 END
          AS event_count,
          tDwi.ssp_token,
          tDwi.rtb_version as rtb_version,
          tDwi.demand_using_time as demand_using_time,
          tDwi.adx_using_time as adx_using_time,
          tDwi.rater_type as rater_type,
          tDwi.rater_id as rater_id,
          tDwi.adomain as adomain,
          tDwi.media_type as media_type,

          pDwi.repeated,
          '0001-01-01 00:00:00' as l_time,
          pDwi.b_date,
          pDwi.b_time,
          pDwi.b_version as b_version

        from (
          select * from nadx_performance_dwi where repeated = 'N' AND b_time >= date_format(current_timestamp() + INTERVAL -1 HOUR, 'yyyy-MM-dd HH:00:00') AND ${b_time_where}
        ) pDwi
        left join (
          select * from nadx_traffic_dwi_40000 where dataType = 4 AND b_time >= date_format(current_timestamp() + INTERVAL -1 HOUR, 'yyyy-MM-dd HH:00:00') AND ${b_time_where}
        ) tDwi ON tDwi.b_time = pDwi.b_time AND pDwi.bidid = tDwi.bidRequestId
        left join (
          select * from nadx_performance_dwi where repeated = 'N' AND b_time >= date_format(current_timestamp() + INTERVAL -1 HOUR, 'yyyy-MM-dd HH:00:00') AND ${b_time_where} AND type = 'win'
        ) winDwi ON winDwi.b_time = pDwi.b_time AND winDwi.bidid = pDwi.bidid;

        -- 去重
        -- drop table if exists nadx_p_matched_dwi_tmp_unrepeated;
        -- create table nadx_p_matched_dwi_tmp_unrepeated as
        select
          repeats                           ,
          rowkey                            ,

          dataType                         ,
          `timestamp`                      ,
          supply_bd_id                     ,
          supply_am_id                     ,
          supply_id                        ,
          supply_protocol                  ,
          request_flag                     ,

          ad_format                         ,
          site_app_id                       ,
          placement_id                      ,
          position                          ,

          country                           ,
          state                             ,
          city                              ,

          carrier                           ,

          os                                ,
          os_version                        ,

          device_type                       ,
          device_brand                      ,
          device_model                      ,

          age                               ,
          gender                            ,

          cost_currency                     ,

        -- demand
          demand_bd_id                      ,
          demand_am_id                      ,
          demand_id                         ,

        -- destination
          demand_seat_id                    ,
          demand_campaign_id                ,
          demand_protocol                   ,
          target_site_app_id                ,
          revenue_currency                  ,

        -- common
          bid_price_model                   ,
          traffic_type                      ,
          currency                          ,

        -- id
          supplyBidId                       ,
          bidRequestId                      ,

          bundle                            ,
          size                              ,

          supply_request_count              ,
        --   待删，冗余
          supply_invalid_request_count      ,
          supply_bid_count                  ,
          supply_bid_price_cost_currency    ,
          supply_bid_price                  ,
          supply_win_count                  ,
          supply_win_price_cost_currency    ,
          supply_win_price                  ,

          demand_request_count              ,
          demand_bid_count                  ,
          demand_bid_price_revenue_currency ,
          demand_bid_price                  ,
          demand_win_count                  ,
          demand_win_price_revenue_currency ,
          demand_win_price                  ,
          demand_timeout_count              ,

          impression_count                  ,
          impression_cost_currency          ,
          impression_cost                   ,
          impression_revenue_currency       ,
          impression_revenue                ,
          click_count                       ,
          click_cost_currency               ,
          click_cost                        ,
          click_revenue_currency            ,
          click_revenue                     ,
          conversion_count                  ,
          conversion_price                  ,
          saveCount                         ,
          bidfloor                          ,
          site_id                           ,
          site_cat                          ,
          site_domain                       ,
          publisher_id                      ,
          app_id                            ,
          tmax                              ,
          ip                                ,
          crid                              ,
          cid                               ,
          tips                              ,
          node                              ,
          tip_type                          ,
          tip_desc                          ,
          adm                               ,

          event_count                       ,
          ssp_token                         ,
          rtb_version                       ,
          demand_using_time                 ,
          adx_using_time                    ,
          rater_type                         ,
          rater_id                           ,
          cast(null as STRING) as  raterType                         ,
          cast(null as STRING) as raterId                           ,
          adomain                           ,
          media_type                           ,


          repeated                          ,
          l_time                            ,
          b_date                            ,
          b_time                            ,
          b_version
        from(
          select
            *,
            row_number() over(partition by dataType, bidRequestId order by 1 desc) row_num
          from nadx_p_matched_dwi_tmp
        )
        where row_num = 1;
      """
    }]
    dwr.enable = true
    dwr.groupby.fields = [
      { expr = "supply_bd_id",       as = "supply_bd_id"},
      { expr = "supply_am_id",       as = "supply_am_id"},
      { expr = "supply_id",          as = "supply_id"},
      { expr = "supply_protocol",    as = "supply_protocol"},
      { expr = "request_flag",       as = "request_flag"},

      { expr = "ad_format",          as = "ad_format"},
      { expr = "site_app_id",        as = "site_app_id"},
      { expr = "placement_id",       as = "placement_id"},
      { expr = "position",           as = "position"},
      { expr = "country",            as = "country"},

      { expr = "state",              as = "state"},
      { expr = "city",               as = "city"},
      { expr = "carrier",            as = "carrier"},
      { expr = "os",                 as = "os"},
      { expr = "os_version",         as = "os_version"},

      { expr = "device_type",        as = "device_type"},
      { expr = "device_brand",       as = "device_brand"},
      { expr = "device_model",       as = "device_model"},
      { expr = "age",                as = "age"},
      { expr = "gender",             as = "gender"},

      { expr = "cost_currency",      as = "cost_currency"},
      { expr = "demand_bd_id",       as = "demand_bd_id"},
      { expr = "demand_am_id",       as = "demand_am_id"},
      { expr = "demand_id",          as = "demand_id"},
      { expr = "demand_protocol",    as = "demand_protocol"},

      { expr = "revenue_currency",   as = "revenue_currency"},
      { expr = "demand_seat_id",     as = "demand_seat_id"},
      { expr = "demand_campaign_id", as = "demand_campaign_id"},
      { expr = "target_site_app_id", as = "target_site_app_id"},
      { expr = "bid_price_model",    as = "bid_price_model"},

      { expr = "traffic_type",       as = "traffic_type"},
      { expr = "currency",           as = "currency"},
      { expr = "bundle",             as = "bundle"},
      { expr = "size",               as = "size"},

      // 待删，用tip_type
      { expr = "null",               as = "tips"},
      { expr = "node",               as = "node"},
      { expr = "tip_type",           as = "tip_type"},
      { expr = "tip_desc",           as = "tip_desc"},
      { expr = "ssp_token",          as = "ssp_token"},
      { expr = "rtb_version",        as = "rtb_version" },
      { expr = "demand_using_time",  as = "demand_using_time" },
      { expr = "adx_using_time",     as = "adx_using_time" },
      { expr = "site_domain",        as = "site_domain"},
      { expr = "publisher_id",       as = "publisher_id"},
      { expr = "rater_type",           as = "rater_type"},
      { expr = "rater_id",             as = "rater_id"},
      { expr = "null",           as = "raterType"},
      { expr = "null",             as = "raterId"},
      { expr = "adomain",             as = "adomain"},
      { expr = "crid",                as = "crid"},
      { expr = "media_type",                as = "media_type"}
    ]
    dwr.groupby.aggs = [
      { expr = "0",                                                                             as ="supply_request_count",              union = "sum(supply_request_count)"},
      { expr = "0",                                                                             as ="supply_invalid_request_count",      union = "sum(supply_invalid_request_count)"},
      { expr = "0",                                                                             as ="supply_bid_count",                  union = "sum(supply_bid_count)"},
      { expr = "0.0",                                                                           as ="supply_bid_price_cost_currency",    union = "sum(supply_bid_price_cost_currency)"},
      { expr = "0.0",                                                                           as ="supply_bid_price",                  union = "sum(supply_bid_price)"},
      { expr = "sum(supply_win_count)",                                                         as ="supply_win_count",                  union = "sum(supply_win_count)",               overwrite = true},
      { expr = "sum(supply_win_price_cost_currency/ IF(bid_price_model = 1, 1000.0, 1.0) )",    as ="supply_win_price_cost_currency",    union = "sum(supply_win_price_cost_currency)", overwrite = true},
      { expr = "sum(supply_win_price/ IF(bid_price_model = 1, 1000.0, 1.0) )",                  as ="supply_win_price",                  union = "sum(supply_win_price)",               overwrite = true},
      { expr = "0",                                                                             as ="demand_request_count",              union = "sum(demand_request_count)"},
      { expr = "0",                                                                             as ="demand_bid_count",                  union = "sum(demand_bid_count)"},

      { expr = "0.0",                                                                           as ="demand_bid_price_revenue_currency", union = "sum(demand_bid_price_revenue_currency)"},
      { expr = "0.0",                                                                           as ="demand_bid_price",                  union = "sum(demand_bid_price)"},
      { expr = "sum(demand_win_count)",                                                         as ="demand_win_count",                  union = "sum(demand_win_count)"},
      { expr = "sum(demand_win_price_revenue_currency/ IF(bid_price_model = 1, 1000.0, 1.0) )", as ="demand_win_price_revenue_currency", union = "sum(demand_win_price_revenue_currency)"},
      { expr = "sum(demand_win_price/ IF(bid_price_model = 1, 1000.0, 1.0) )",                  as ="demand_win_price",                  union = "sum(demand_win_price)"},

      { expr = "sum(demand_timeout_count)",                                                     as ="demand_timeout_count",              union = "sum(demand_timeout_count)"},
      { expr = "sum(impression_count)",                                                         as ="impression_count",                  union = "sum(impression_count)",            overwrite = true},

      { expr = "sum(impression_cost_currency/ IF(bid_price_model = 1, 1000.0, 1.0) )",          as ="impression_cost_currency",          union = "sum(impression_cost_currency)",    overwrite = true},
      { expr = "sum(impression_cost/ IF(bid_price_model = 1, 1000.0, 1.0) )",                   as ="impression_cost",                   union = "sum(impression_cost)",             overwrite = true},

      {expr = "sum(impression_revenue_currency/ IF(bid_price_model = 1, 1000.0, 1.0) )",        as ="impression_revenue_currency",       union = "sum(impression_revenue_currency)", overwrite = true},

      { expr = "sum(impression_revenue/ IF(bid_price_model = 1, 1000.0, 1.0) )",                as ="impression_revenue",                union = "sum(impression_revenue)",          overwrite = true},
      { expr = "sum(click_count)",                                                              as ="click_count",                       union = "sum(click_count)",                 overwrite = true},

      { expr = "sum(click_cost_currency)",                                                      as ="click_cost_currency",               union = "sum(click_cost_currency)",         overwrite = true},
      { expr = "sum(click_cost)",                                                               as ="click_cost",                        union = "sum(click_cost)",                  overwrite = true},
      { expr = "sum(click_revenue_currency)",                                                   as ="click_revenue_currency",            union = "sum(click_revenue_currency)",      overwrite = true},

      { expr = "sum(click_revenue)",                                                            as ="click_revenue",                     union = "sum(click_revenue)",               overwrite = true},
      { expr = "sum(conversion_count)",                                                         as ="conversion_count",                  union = "sum(conversion_count)",            overwrite = true},
      { expr = "sum(conversion_price)",                                                         as ="conversion_price",                  union = "sum(conversion_price)",            overwrite = true},
      { expr = "sum(event_count)",                                                              as ="event_count",                       union = "sum(event_count)",                 overwrite = true},
      { expr = "avg(bidfloor)",                                                                 as ="bidfloor",                          union = "avg(bidfloor)",                    overwrite = true}       

    ]
    dwr.include.repeated = true
    dwr.table = "nadx_overall_dwr"
    kafka.consumer {
      partitoins = [
        {
          topic = "topic_empty"
          partition = 0
        }
      ]
    }
  }

}
